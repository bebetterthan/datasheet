# Vulnerability Detection Patterns
# ================================
# Patterns for common web vulnerabilities

# =============================================================================
# SQL INJECTION
# =============================================================================

sqli:
  # Error-based indicators
  error_mysql:
    patterns:
      - "You have an error in your SQL syntax"
      - "mysql_fetch_array()"
      - "mysql_fetch_assoc()"
      - "mysql_num_rows()"
      - "Warning.*mysql_"
      - "MySqlException"
      - "com.mysql.jdbc"
    severity: high
    description: "MySQL Error Exposure"
    
  error_postgres:
    patterns:
      - "PostgreSQL.*ERROR"
      - "Warning.*pg_"
      - "valid PostgreSQL result"
      - "Npgsql\\."
      - "org.postgresql.util.PSQLException"
    severity: high
    description: "PostgreSQL Error Exposure"
    
  error_mssql:
    patterns:
      - "Driver.*SQL Server"
      - "OLE DB.*SQL Server"
      - "SQLServer JDBC Driver"
      - "SqlClient\\."
      - "Unclosed quotation mark"
      - "mssql_query()"
    severity: high
    description: "MSSQL Error Exposure"
    
  error_oracle:
    patterns:
      - "ORA-[0-9]{5}"
      - "Oracle.*Driver"
      - "Warning.*oci_"
      - "quoted string not properly terminated"
    severity: high
    description: "Oracle Error Exposure"
    
  error_sqlite:
    patterns:
      - "SQLite/JDBCDriver"
      - "SQLite.*Exception"
      - "System.Data.SQLite.SQLiteException"
      - "Warning.*sqlite_"
      - "SQLITE_ERROR"
    severity: high
    description: "SQLite Error Exposure"
    
  # Generic SQL errors
  generic_sql:
    patterns:
      - "SQL syntax.*error"
      - "syntax error at or near"
      - "unexpected end of SQL"
      - "incorrect syntax near"
      - "unterminated quoted string"
      - "ODBC.*Driver"
    severity: medium
    description: "Generic SQL Error"

# =============================================================================
# CROSS-SITE SCRIPTING (XSS)
# =============================================================================

xss:
  # Reflected patterns
  reflected_vectors:
    patterns:
      - '<script[^>]*>[^<]*</script>'
      - 'javascript:'
      - 'onerror\s*='
      - 'onload\s*='
      - 'onclick\s*='
      - 'onmouseover\s*='
      - 'onfocus\s*='
      - 'onblur\s*='
      - '<img[^>]+onerror'
      - '<svg[^>]+onload'
      - '<body[^>]+onload'
      - '<iframe[^>]+src\s*=\s*["\']?javascript:'
      - 'expression\s*\('
      - 'vbscript:'
    severity: high
    description: "XSS Vector Detected"
    
  # DOM-based XSS sinks
  dom_sinks:
    patterns:
      - 'document\.write\s*\('
      - 'document\.writeln\s*\('
      - '\.innerHTML\s*='
      - '\.outerHTML\s*='
      - '\.insertAdjacentHTML\s*\('
      - 'eval\s*\('
      - 'setTimeout\s*\([^,]*,'
      - 'setInterval\s*\([^,]*,'
      - 'new\s+Function\s*\('
      - '\.html\s*\('
      - '\$\s*\([^)]*\)\.html\s*\('
    severity: medium
    description: "DOM XSS Sink"
    
  # DOM-based XSS sources
  dom_sources:
    patterns:
      - 'location\.hash'
      - 'location\.search'
      - 'location\.href'
      - 'document\.URL'
      - 'document\.documentURI'
      - 'document\.referrer'
      - 'window\.name'
      - 'document\.cookie'
    severity: info
    description: "DOM XSS Source"

# =============================================================================
# PATH TRAVERSAL
# =============================================================================

path_traversal:
  indicators:
    patterns:
      - '\.\./\.\.'
      - '\.\.\\.\.\\'
      - '%2e%2e%2f'
      - '%2e%2e/'
      - '..%2f'
      - '%2e%2e%5c'
      - '..%5c'
      - '..%255c'
      - '..%c0%af'
      - '..%c1%9c'
    severity: medium
    description: "Path Traversal Attempt"
    
  exposed_files:
    patterns:
      - '/etc/passwd'
      - '/etc/shadow'
      - '/etc/hosts'
      - 'c:\\windows\\system32'
      - 'c:\\boot.ini'
      - '/proc/self/'
    severity: high
    description: "Sensitive File Exposure"

# =============================================================================
# SERVER-SIDE REQUEST FORGERY (SSRF)
# =============================================================================

ssrf:
  internal_urls:
    patterns:
      - 'http://127\.'
      - 'http://localhost'
      - 'http://0\.0\.0\.0'
      - 'http://10\.'
      - 'http://172\.(1[6-9]|2[0-9]|3[0-1])\.'
      - 'http://192\.168\.'
      - 'http://169\.254\.'
      - 'file://'
      - 'gopher://'
      - 'dict://'
    severity: high
    description: "SSRF Internal URL"
    
  cloud_metadata:
    patterns:
      - '169\.254\.169\.254'
      - 'metadata\.google\.internal'
      - 'metadata\.aws\.internal'
      - '100\.100\.100\.200'
    severity: critical
    description: "Cloud Metadata URL"

# =============================================================================
# COMMAND INJECTION
# =============================================================================

command_injection:
  shell_metacharacters:
    patterns:
      - '\|\s*[a-zA-Z]'
      - ';\s*[a-zA-Z]'
      - '\$\([^)]+\)'
      - '`[^`]+`'
      - '\|\|'
      - '&&'
      - '\n[a-zA-Z]'
      - '\r[a-zA-Z]'
    severity: high
    description: "Command Injection Character"
    
  dangerous_commands:
    patterns:
      - '\b(?:cat|ls|dir|whoami|id|pwd|wget|curl)\b'
      - '\b(?:nc|netcat|ncat)\b'
      - '\b(?:bash|sh|cmd|powershell)\b'
      - '/bin/(?:sh|bash|csh|tcsh)'
    severity: high
    description: "Potentially Dangerous Command"
    context_required: true

# =============================================================================
# XML EXTERNAL ENTITY (XXE)
# =============================================================================

xxe:
  external_entity:
    patterns:
      - '<!ENTITY[^>]+SYSTEM'
      - '<!ENTITY[^>]+PUBLIC'
      - '<!DOCTYPE[^>]+\['
      - 'ENTITY[^>]+file://'
      - 'ENTITY[^>]+http://'
      - 'ENTITY[^>]+ftp://'
    severity: high
    description: "XXE Entity Definition"
    
  parameter_entity:
    patterns:
      - '%[a-zA-Z_][a-zA-Z0-9_]*;'
    severity: medium
    description: "XXE Parameter Entity"

# =============================================================================
# INSECURE DESERIALIZATION
# =============================================================================

deserialization:
  java_serialized:
    patterns:
      - 'rO0AB'  # Base64 Java serialized object
      - '\xac\xed\x00\x05'  # Java serialization magic bytes
      - 'ObjectInputStream'
      - 'readObject\(\)'
    severity: high
    description: "Java Serialized Object"
    
  php_serialized:
    patterns:
      - '[Oo]:[0-9]+:"[^"]+":' # PHP object
      - '[Aa]:[0-9]+:{' # PHP array
      - '__wakeup'
      - '__destruct'
      - 'unserialize\s*\('
    severity: high
    description: "PHP Serialized Data"
    
  python_pickle:
    patterns:
      - 'cPickle'
      - 'pickle\.loads'
      - '\x80\x04\x95'  # Pickle protocol 4
    severity: high
    description: "Python Pickle Data"
    
  dotnet_serialized:
    patterns:
      - 'TypeNameHandling'
      - 'ObjectDataProvider'
      - 'BinaryFormatter'
      - 'NetDataContractSerializer'
    severity: high
    description: ".NET Serialized Object"

# =============================================================================
# SECURITY MISCONFIGURATIONS
# =============================================================================

misconfig:
  directory_listing:
    patterns:
      - 'Index of /'
      - '<title>Index of'
      - 'Directory listing for'
      - 'Parent Directory</a>'
      - '\[To Parent Directory\]'
    severity: medium
    description: "Directory Listing Enabled"
    
  version_disclosure:
    patterns:
      - 'Apache/[0-9.]+'
      - 'nginx/[0-9.]+'
      - 'Microsoft-IIS/[0-9.]+'
      - 'PHP/[0-9.]+'
      - 'X-Powered-By:'
      - 'Server:'
    severity: low
    description: "Version Information Disclosure"
    
  debug_mode:
    patterns:
      - 'DJANGO_DEBUG\s*=\s*True'
      - 'APP_DEBUG\s*=\s*true'
      - 'debug_toolbar'
      - 'Traceback \(most recent call last\)'
      - 'stack trace'
    severity: medium
    description: "Debug Mode Enabled"
    
  default_credentials:
    patterns:
      - 'admin:admin'
      - 'root:root'
      - 'test:test'
      - 'user:user'
      - 'password:password'
      - 'default:default'
    severity: high
    description: "Default Credentials"

# =============================================================================
# AUTHENTICATION & SESSION
# =============================================================================

auth_issues:
  weak_password:
    patterns:
      - 'password\s*[:=]\s*["\'](?:password|123456|admin|12345678|qwerty)["\']'
    severity: high
    description: "Weak Password Detected"
    
  hardcoded_jwt:
    patterns:
      - 'eyJ[a-zA-Z0-9_-]*\.eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*'
    severity: medium
    description: "Hardcoded JWT Token"
    
  session_fixation:
    patterns:
      - 'JSESSIONID\s*='
      - 'PHPSESSID\s*='
      - 'ASP\.NET_SessionId\s*='
    severity: info
    description: "Session ID in URL/Form"
    context_required:
      - "url"
      - "href"
      - "action"
